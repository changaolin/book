# HASS安装（基于树莓派）

# 一、[下载资源](https://www.home-assistant.io/installation/raspberrypi)

- 硬件准备：树莓派（3或者4）、配套电源、内存卡、读卡器
- img镜像
  - [Pi4](https://github.com/home-assistant/operating-system/releases/download/9.5/haos_rpi4-64-9.5.img.xz) https://github.com/home-assistant/operating-system/releases/download/9.5/haos_rpi4-64-9.5.img.xz
  - [Pi3](https://github.com/home-assistant/operating-system/releases/download/9.5/haos_rpi3-64-9.5.img.xz) https://github.com/home-assistant/operating-system/releases/download/9.5/haos_rpi3-64-9.5.img.xz
- 下载器[Balena Etcher](https://www.balena.io/etcher)

# 二、安装镜像

- 使用下载器烧录镜像到内存卡
- 将内存卡插入树莓派，插入网线
  - 连接显示器，键盘，启动树莓派，终端输入 su update 进行更新
  - 或者在路由器上查询到树莓派IP之后，使用IP:8123 的界面进行更新

# 三、配置ssh

- 开启高级模式
  - 点击用户名，打开高级选项
- 在加载项中搜索ssh，安装Terminal & SSH
- 在插件SSH中配置登录密码，默认账号为root，修改登录端口为2222，重启插件进行连接。

# 四、[安装hacs](https://hacs.xyz/docs/setup/download)

- ssh登录到hass上，执行附件脚本进行安装，安装完成后按提示重启hass
- 或者 在线安装
  - wget -O - https://get.hacs.xyz | bash -
- 在集成页面搜索HACS，提交之后按照提示进行[github认证](https://hacs.xyz/docs/configuration/basic)。

# 五、支持[米家](https://zhuanlan.zhihu.com/p/392587917)和Aqara

- 在左边拦的HACS中添加Xiaomi Miot Auto、 Xiaomi Miot 和 Xiaomi Gateway3（Aqara用） 三个库，重启HASS
- 或者根据说明手动[下载](https://github.com/ha0y/xiaomi_miot_raw) 
  - 下载插件 [zip 压缩包](https://github.com/ha0y/xiaomi_miot_raw/archive/refs/heads/master.zip)（该链接始终为最新版本）。
  - 依次打开压缩包中的`xiaomi_miot_raw-master`/`custom_components`文件夹。
  - 将该文件夹中的`xiaomi_miot_raw`文件夹拷贝至自己 HA 安装目录的`custom_components`文件夹
- 重启HASS后，在集成界面分别添加Xiaomi Miot和 Xiaomi Gateway3.

# 六、[连接Apple中枢-家庭](https://zhuanlan.zhihu.com/p/392587917)

- 添加集成 Home Assistant Bridge

- 根据信息提示 使用家庭APP扫面二维码添加桥接设备即可。

  - 需要在**.homeassistant** 目录下的configuration.yaml  中增加homekit配置

    ```yaml
    # Loads default set of integrations. Do not remove.
    default_config:
    
    # Load frontend themes from the themes folder
    frontend:
      themes: !include_dir_merge_named themes
    
    # Text to speech
    tts:
      - platform: google_translate
    
    automation: !include automations.yaml
    script: !include scripts.yaml
    scene: !include scenes.yaml
    homekit:
    ```

    

# 七、附件脚本

```shell
#!/bin/bash
# wget -O - https://get.hacs.xyz | bash -
set -e

RED_COLOR='\033[0;31m'
GREEN_COLOR='\033[0;32m'
GREEN_YELLOW='\033[1;33m'
NO_COLOR='\033[0m'

declare haPath
declare -a paths=(
    "$PWD"
    "$PWD/config"
    "/config"
    "$HOME/.homeassistant"
    "/usr/share/hassio/homeassistant"
)
declare currentVersion
declare currentYear
declare currentMonth
declare currentPatch
declare targetVersion
declare targetYear
declare targetMonth
declare targetPatch

function info () { echo -e "${GREEN_COLOR}INFO: $1${NO_COLOR}";}
function warn () { echo -e "${GREEN_YELLOW}WARN: $1${NO_COLOR}";}
function error () { echo -e "${RED_COLOR}ERROR: $1${NO_COLOR}"; if [ "$2" != "false" ]; then exit 1;fi; }

function checkRequirement () {
    if [ -z "$(command -v "$1")" ]; then
        error "'$1' is not installed"
    fi
}

checkRequirement "wget"
checkRequirement "unzip"

info "Trying to find the correct directory..."
for path in "${paths[@]}"; do
    if [ -n "$haPath" ]; then
        break
    fi

    if [ -f "$path/.HA_VERSION" ]; then
        haPath="$path"
    fi
done

if [ -n "$haPath" ]; then
    info "Found Home Assistant configuration directory at '$haPath'"
    cd "$haPath" || error "Could not change path to $haPath"
    if [ ! -d "$haPath/custom_components" ]; then
        info "Creating custom_components directory..."
        mkdir "$haPath/custom_components"
    fi

    info "Changing to the custom_components directory..."
    cd "$haPath/custom_components" || error "Could not change path to $haPath/custom_components"

    info "Downloading HACS"
    wget "https://github.com/hacs/integration/releases/latest/download/hacs.zip"

    if [ -d "$haPath/custom_components/hacs" ]; then
        warn "HACS directory already exist, cleaning up..."
        rm -R "$haPath/custom_components/hacs"
    fi

    info "Creating HACS directory..."
    mkdir "$haPath/custom_components/hacs"

    info "Unpacking HACS..."
    unzip "$haPath/custom_components/hacs.zip" -d "$haPath/custom_components/hacs" >/dev/null 2>&1


    echo
    info "Verifying versions"
    targetVersion=$(sed -n -e '/^MINIMUM_HA_VERSION/p' "$haPath/custom_components/hacs/const.py" | cut -d '"' -f 2)
    currentVersion=$(cat "$haPath/.HA_VERSION")

    info "Current version is ${currentVersion}, minimum version is ${targetVersion}"

    targetYear=$(echo "${targetVersion}" | cut -d "." -f 1)
    currentYear=$(echo "${currentVersion}" | cut -d "." -f 1)

    if [ "${currentYear}" -lt "${targetYear}" ]; then
        rm -R "$haPath/custom_components/hacs"
        error "Version ${currentVersion} is not new enough, needs at least ${targetVersion}"
    fi

    if [ "${currentYear}" == "${targetYear}" ]; then
        targetMonth=$(echo "${targetVersion}" | cut -d "." -f 2)
        currentMonth=$(echo "${currentVersion}" | cut -d "." -f 2)

        if [ "${currentMonth}" -lt "${targetMonth}" ]; then
        rm -R "$haPath/custom_components/hacs"
            error "Version ${currentVersion} is not new enough, needs at least ${targetVersion}"
        fi

        if [ "${currentMonth}" == "${targetMonth}" ]; then
            targetPatch=$(echo "${targetVersion}" | cut -d "." -f 3)
            currentPatch=$(echo "${currentVersion}" | cut -d "." -f 3)

            if [ "${currentPatch}" -lt "${targetPatch}" ]; then
                rm -R "$haPath/custom_components/hacs"
                error "Version ${currentVersion} is not new enough, needs at least ${targetVersion}"
            fi
        fi
    fi

    echo
    info "Removing HACS zip file..."
    rm "$haPath/custom_components/hacs.zip"
    info "Installation complete."
    echo
    info "Remember to restart Home Assistant before you configure it"

else
    echo
    error "Could not find the directory for Home Assistant" false
    echo "Manually change the directory to the root of your Home Assistant configuration"
    echo "With the user that is running Home Assistant"
    echo "and run the script again"
    exit 1
fi
```

